{% extends 'base/main.html' %}
{% block content %}
<style>
  .block {
    background-color:#fff;
    height:125px;
    text-align:center;
    padding:15px 0;
  }

  .block {
    font-size:16pt;
  }

  .numberbox {
    font-size:30pt;
    font-weight:bold;
  }

  .red {
    background-color: red;
    color: white;
  }

  .green {
    background-color: green;
    color:white;
  }
</style>
<div class="row show-grid" style="padding-top:15px;">
  <div class="span-one-third column block {% if delta.closed_count > 0 %}green{% else %}red{% endif %}">
    <div id="closed-requests" class="numberbox">{{ this_week_stats.closed_request_count }} </div> 
    requests closed this week.
    <strong>{{ delta.closed_count}}%</strong> change in requests closed from last week to
    this.
  </div>

  <div class="span-one-third column block">
    <div id="opened-requests" class="numberbox">{{ this_week_stats.request_count}} </div>requests opened this week.
    <strong>{{ delta.opened_count }}%</strong> change in requests from last week to
    this.
  </div>

  <div class="span-one-third column block {% if delta.time < 0 %}green{% else %}red{% endif %}">
    <div id="average-response" class="numberbox"></div>
      average response time.
   {{ delta.time }}% change in response time from last week to this.
  </div>
</div>

<div class="row">
  <div class="span10 column" style="background-color:#fff;">
   Hello 
    <select class="chzn-select" id="neighborhood-selector">
      <option>San Francisco</option>
      <optgroup label="Neighborhoods">
        {% for neighborhood in neighborhoods %}
        <option value="{{ neighborhood.id }}">{{ neighborhood.name }}</option>
        {% endfor %}
      </optgroup>
    </select>, let's see how responsive your city is this week.
  </div>
  <div id="selector" class="span6 column border-radius">
    Select a map:
    <select id="layer-select" class="chzn-select" style="width:100px;">
      <option value="cleaning">Street/Sidewalk Cleaning</option>
      <option value="cans">Trash Cans</option>
      <option value="dumping">Illegal Dumping</option>
      <option value="graffiti" selected="true">Graffiti</option>
      <option value="overflowing">Overflowing City Recepticles</option>
      <option value="pavementdefect">Pavement Defect</option>
      <option value="sewer">Sewer</option>
      <option value="vehicle">Abandoned Vehicle</option>
    </select>
  </div>
</div>
<!-- Display map here -->
<style>
  #streets path:hover, #sidewalk_cleaning path:hover, #graffiti path:hover {
    stroke-width:5px;
  }
</style>

<div id="map" style="border:1px solid #ccc;" class="container border-radius">
</div>
{% endblock %}

{% block custom_scripts %}
<script src="/static/js/map.js"></script>
<script src="{{ STATIC_URL }}/js/date.js"></script>
<script src="/static/js/raycasting.js"></script>

<script>
  $(document).ready(function () {
    $('.chzn-select').chosen();

    $("#layer-select").chosen().change(function (e) {
      Map.switchVisibleLayer(window[this.value]);
    });

    // Get open/closed counts, average response time.
    var today = Date.today().toString('yyyy-M-d');
    var week_ago = Date.today().addDays(-7).toString('yyyy-M-d');
    o3d.API.query = {
      requested_datetime_start: week_ago,
      requested_datetime_end: today
    }
    $.get('/api/requests/count/?'+ $.param(o3d.API.query),
      function(data) {
          $("#opened-requests").html(data[0].count);
        }
    );

    $.get('/api/requests/avg_response/?'+ $.param(o3d.API.query),
      function(data) {
        try {
          $("#average-response").html(o3d.time.ms2human(data.avg_time));
        } catch (err) {
          $("#average-response").html("0");
        }
      }
    );

    o3d.API.query = {
      updated_datetime_start: week_ago,
      updated_datetime_end: today,
      status: 'Closed'
    }

    $.get('/api/requests/count/?' + $.param(o3d.API.query),
    function(data) {
      try {
        $("#closed-requests").html(data[0].count);
      } catch(err) {
      $("#closed-requests").html("0");
    }
    });
    $.get('/api/requests/count/?keys=status&status=Closed')
  });
</script>

{% endblock %}
